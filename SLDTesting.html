<h1>Notes on WFS implementations and SLDs</h1>
<p>Stephen M Richard, 2013-10-08</p>
<p>In an SLD-enabled WMS, </p>
<ul>
<li>
<p>LAYERS and STYLES parameters are optional when an SLD parameter is supplied.</p>
</li>
<li>
<p>when the LAYERS and STYLES parameters are supplied and an SLD parameter is supplied, the WMS goes into 'library mode' and has to try and work out which of the external (e.g. supplied via the SLD parameter value) styles and which of the internal styles (e.g. supplied via the LAYERS and STYLES parameter values) it applies.</p>
</li>
</ul>
<h2>from OGC 05-078r4:</h2>
<p>To make the HTTP-GET methods more practical for use, the SLD can also be used in
one of two different modes depending on whether the LAYERS parameter is present in
the request.</p>
<p><strong>If the LAYERS parameter is NOT present in the request</strong>, then all layers identified in the SLD document are
rendered with all defined styles.</p>
<p><strong>If the LAYERS parameter is present in the request</strong>, then only the layers identified by that parameter are
rendered and the SLD is used as a <em>'style library'</em>.</p>
<p>When an SLD is used as a <em>style library</em>, the STYLES parameter is interpreted such that the styles defined in the SLD take precedence over the named styles stored within the map server. If the LAYER specified by the request LAYER parameter is defined and in the SLD, and has an associated STYLE with a name matching the STYLE parameter value in the request, then the SLD definition is used. Otherwise, the standard named-style mechanism built into the map server is used.</p>
<p>User-defined SLD styles can be given names and they can be marked as being the default STYLE for a LAYER.
IF the request specifies STYLE=default, and the SLD contains a STYLE marked as default for a LAYER matching the request LAYER parameter value, then that default style from the SLD is used; otherwise, the standard default style for the LAYER defined by the map server is used.</p>
<h2>Test Links</h2>
<h3>Minnesota Mapserver target</h3>
<p><a href="http://ogc.bgs.ac.uk/cgi-bin/BGS_Bedrock_and_Superficial_Geology/wms?REQUEST=GetCapabilities&amp;SERVICE=WMS&amp;VERSION=1.3.0">Capabilities for service</a> has layer named UKCoShelf_BGS_1M_SBS, no prefix.</p>
<p><a href="http://ogc.bgs.ac.uk/cgi-bin/BGS_Bedrock_and_Superficial_Geology/wms?REQUEST=GetMap&amp;SERVICE=WMS&amp;VERSION=1.3.0&amp;FORMAT=image/png&amp;BGCOLOR=0xFFFFFF&amp;TRANSPARENT=TRUE&amp;CRS=EPSG:4326&amp;BBOX=49.0,-10.5,61.9,3.2&amp;WIDTH=900&amp;HEIGHT=881&amp;LAYERS=UKCoShelf_BGS_1M_SBS&amp;STYLES=default&amp;">Original GetMap request with no SLD param</a>, Gets submarine geology around the UK.</p>
<p><a href="http://ogc.bgs.ac.uk/cgi-bin/BGS_Bedrock_and_Superficial_Geology/wms?REQUEST=GetMap&amp;SERVICE=WMS&amp;VERSION=1.3.0&amp;FORMAT=image/png&amp;BGCOLOR=0xFFFFFF&amp;TRANSPARENT=TRUE&amp;CRS=EPSG:4326&amp;BBOX=49.0,-10.5,61.9,3.2&amp;WIDTH=900&amp;HEIGHT=881&amp;SLD=http%3A%2F%2Fogc.bgs.ac.uk%2Fsld%2FUKCoShelf_BGS_1M_SBS-original-mod3a.sld">GetMap with an external SLD (no layers or styles params supplied)</a></p>
<p><a href="http://ogc.bgs.ac.uk/cgi-bin/BGS_Bedrock_and_Superficial_Geology/wms?REQUEST=GetMap&amp;SERVICE=WMS&amp;VERSION=1.3.0&amp;FORMAT=image/png&amp;BGCOLOR=0xFFFFFF&amp;TRANSPARENT=TRUE&amp;CRS=EPSG:4326&amp;BBOX=49.0,-10.5,61.9,3.2&amp;WIDTH=900&amp;HEIGHT=881&amp;SLD=http%3A%2F%2Fogc.bgs.ac.uk%2Fsld%2FUKCoShelf_BGS_1M_SBS-original-mod3a.sld&amp;LAYERS=UKCoShelf_BGS_1M_SBS&amp;STYLES=default&amp;">GetMap with the external SLD and with layers and styles params</a> gives you the same result as the external SLD without the layers and styles params, which is the expected result in this scenario.</p>
<p><a href="http://ogc.bgs.ac.uk/sld/UKCoShelf_BGS_1M_SBS-original-mod3a.sld">SLD Location:</a> This is a v1.1.0 SLD, named layer is UKCoShelf_BGS_1M_SBS, no prefix.
This is a Layer/Name in the capabilities document for the service</p>

<h3>Nevada, ArcGIS server</h3>
<p><a href="http://gisweb.unr.edu/arcgis/services/OneGeology/NBMG_Geology/MapServer/WMSServer?SERVICE=WMS&amp;VERSION=1.3.0&amp;REQUEST=GetCapabilities">Get Capabilities</a>. Has layer name US-NV_NBMG_500k_Geology, no prefix. A default style element is present.</p>
<p><a href="http://gisweb.unr.edu/arcgis/services/OneGeology/NBMG_Geology/MapServer/WMSServer?SERVICE=WMS&amp;VERSION=1.3.0&amp;REQUEST=GetMap&amp;BBOX=39.7,-116.2,41,-114.6&amp;CRS=EPSG:4326&amp;WIDTH=925&amp;HEIGHT=802&amp;LAYERS=US-NV_NBMG_500k_Geology&amp;STYLES=&amp;FORMAT=image/jpeg&amp;DPI=96&amp;MAP_RESOLUTION=96&amp;FORMAT_OPTIONS=dpi:96&amp;SLD=http%3A%2F%2Fogc.bgs.ac.uk%2Fsld%2Fnevada-example.sld&amp;">Layers and Styles parameters with ArcGIS server and SLD WMS:</a>. This works.</p>
<p><a href="http://gisweb.unr.edu/arcgis/services/OneGeology/NBMG_Geology/MapServer/WMSServer?SERVICE=WMS&amp;VERSION=1.3.0&amp;REQUEST=GetMap&amp;BBOX=39.66370840865538128,-116.13087390374420238,40.95995233180237705,-114.63744574291149547&amp;CRS=EPSG:4326&amp;WIDTH=925&amp;HEIGHT=802&amp;FORMAT=image/jpeg&amp;DPI=96&amp;MAP_RESOLUTION=96&amp;FORMAT_OPTIONS=dpi:96&amp;SLD=http%3A%2F%2Fogc.bgs.ac.uk%2Fsld%2Fnevada-example.sld&amp;"> SLD WMS request, without LAYERS and STYLES parameters:</a>; this errors:</p>
<p><code>&lt;ServiceException code=&quot;StylesNotDefined&quot;&gt;Parameter 'styles' is required.&lt;/ServiceException&gt;</code></p>
<p><code>&lt;ServiceException code=&quot;LayerNotDefined&quot;&gt;Parameter 'layer(s)' contains unacceptable value:&lt;/ServiceException&gt;</code></p>
<p><a href="http://ogc.bgs.ac.uk/sld/nevada-example.sld">SLD location</a>. The NamedLayer/Name has no prefix.</p>
<h3>Delaware GeoServer implementation</h3>
<p><a href="http://maps.dgs.udel.edu/geoserver/DGS_Surficial_and_Contact_Geology/wms?service=WMS&amp;version=1.3.0&amp;request=GetCapabilities">WMS service capabilities with workspace name in the capabilities URL:</a>.  The geoserver workspace prefixes are not included in the layer names.</p>
<p><a href="http://maps.dgs.udel.edu/geoserver/wms?service=WMS&amp;version=1.3.0&amp;request=GetCapabilities">WMS service capabilities without workspace name in the URL:</a>. The geoserver workspace prefixes <strong>are</strong> included in the layer names...</p>
<p><a href="http://maps.dgs.udel.edu/geoserver/web/;jsessionid=14593A27F8946A750C80073FD1096CFD?wicket:bookmarkablePage=:org.geoserver.web.demo.MapPreviewPage">Delaware GS GeoServer landing page, layer list:</a>. on the second page of the listing, the OneGeology layers show up with namespace qualifiers DGS_Surficial_and_Contact_Geology:US-DE_DGS_100k_Surficial_Geology	US-DE,  DGS_Surficial_and_Contact_Geology:US-DE_DGS_100k_Surficial_Geology_Contacts. The namespace qualifiers are the workspace names in the Geoserver configuration (or at least that's how it works in the AZGS geoserver setup).</p>
<p><a href="http://maps.dgs.udel.edu/geoserver/DGS_Surficial_and_Contact_Geology/wms?service=WMS&amp;TRANSPARENT=TRUE&amp;version=1.3.0&amp;request=GetMap&amp;EXCEPTIONS=INIMAGE&amp;FORMAT=image/png&amp;CRS=EPSG%3A4326&amp;BBOX=39.5,-75.8,39.85,-75.4&amp;WIDTH=900&amp;HEIGHT=1000&amp;LAYERS=US-DE_DGS_100k_Surficial_Geology&amp;STYLES=&amp;">Geology, lithostratigraphy portrayal, no namespace qualifier on layer</a>.  A standard GetMap request (No SLD parameter supplied) which gives the default colouring for the geology polygons.</p>
<p><a href="http://maps.dgs.udel.edu/geoserver/DGS_Surficial_and_Contact_Geology/wms?service=WMS&amp;TRANSPARENT=TRUE&amp;version=1.3.0&amp;request=GetMap&amp;EXCEPTIONS=INIMAGE&amp;FORMAT=image/png&amp;CRS=EPSG%3A4326&amp;BBOX=39.5,-75.8,39.85,-75.4&amp;WIDTH=900&amp;HEIGHT=1000&amp;LAYERS=DGS_Surficial_and_Contact_Geology:US-DE_DGS_100k_Surficial_Geology&amp;STYLES=&amp;">Geology, lithostratigraphy portrayal, LAYER parameter has namespace qualifier</a> also works.</p>
<p><a href="http://maps.dgs.udel.edu/geoserver/wms?service=WMS&amp;TRANSPARENT=TRUE&amp;version=1.3.0&amp;request=GetMap&amp;EXCEPTIONS=INIMAGE&amp;FORMAT=image/png&amp;CRS=EPSG%3A4326&amp;BBOX=39.5,-75.8,39.85,-75.4&amp;WIDTH=900&amp;HEIGHT=1000&amp;LAYERS=US-DE_DGS_100k_Surficial_Geology&amp;STYLES=&amp;">Geology, lithostratigraphy portrayal, WMS end point URL DOES NOT include the workspace name</a> also works, both when the layer name has workspace prefix and when it does not.</p>
<p>The portal tool generates an SLD based on the layer name advertised in the WMS service GetCapabilities response and sends the <a href="http://maps.dgs.udel.edu/geoserver/DGS_Surficial_and_Contact_Geology/wms?service=WMS&amp;TRANSPARENT=TRUE&amp;version=1.3.0&amp;request=GetMap&amp;EXCEPTIONS=INIMAGE&amp;FORMAT=image/png&amp;CRS=EPSG%3A4326&amp;BBOX=39.5,-75.8,39.85,-75.4&amp;WIDTH=900&amp;HEIGHT=1000&amp;SLD=http%3A%2F%2Fogc.bgs.ac.uk%2Fsld%2Fgeoserver-style-test-no-named-style.sld&amp;">SLD WMS GetMap request without the optional LAYERS and STYLES parameters</a>, and that gives what we were expecting (a blue map colouring some of the polygons). The named layer in the SLD has no workspace prefix.</p>
<p><a href="http://maps.dgs.udel.edu/geoserver/wms?service=WMS&amp;TRANSPARENT=TRUE&amp;version=1.3.0&amp;request=GetMap&amp;EXCEPTIONS=INIMAGE&amp;FORMAT=image/png&amp;CRS=EPSG%3A4326&amp;BBOX=39.5,-75.8,39.85,-75.4&amp;WIDTH=900&amp;HEIGHT=1000&amp;SLD=http%3A%2F%2Fogc.bgs.ac.uk%2Fsld%2Fgeoserver-style-test-no-named-style.sld&amp;">SLD WMS GetMap request without LAYERS and STYLES parameters, no workspace in end point URL</a>, also gives what we were expecting (a blue map colouring some of the polygons). The named layer in the SLD has no workspace prefix, and the service endpoint URL doesn't include the workspace name.</p>
<p><a href="http://maps.dgs.udel.edu/geoserver/DGS_Surficial_and_Contact_Geology/wms?service=WMS&amp;TRANSPARENT=TRUE&amp;version=1.3.0&amp;request=GetMap&amp;EXCEPTIONS=INIMAGE&amp;FORMAT=image/png&amp;CRS=EPSG%3A4326&amp;BBOX=39.5,-75.8,39.85,-75.4&amp;WIDTH=900&amp;HEIGHT=1000&amp;SLD=http%3A%2F%2Fogc.bgs.ac.uk%2Fsld%2Fgeoserver-style-test-no-named-style.sld&amp;LAYERS=US-DE_DGS_100k_Surficial_Geology&amp;STYLES=&amp;">SLD WMS GetMap request with LAYERS and STYLES parameter, no workspace prefix on SLD layer name</a>; this returns the map based on the default portrayal, NOT the SLD portrayal. The SLD named layer does not match a named layer in the service.  The SLD namedLayer/name (US-DE_DGS_100k_Surficial_Geology) has no workspace prefix.</p>
<p><a href="http://ogc.bgs.ac.uk/sld/geoserver-style-test-no-named-style.sld">SLD location</a>, version 1.0.0, namedLayer/name=US-DE_DGS_100k_Surficial_Geology</p>
<p><a href="http://maps.dgs.udel.edu/geoserver/DGS_Surficial_and_Contact_Geology/wms?service=WMS&amp;TRANSPARENT=TRUE&amp;version=1.3.0&amp;request=GetMap&amp;EXCEPTIONS=INIMAGE&amp;FORMAT=image/png&amp;CRS=EPSG%3A4326&amp;BBOX=39.5,-75.8,39.85,-75.4&amp;WIDTH=900&amp;HEIGHT=1000&amp;SLD=http%3A%2F%2Fogc.bgs.ac.uk%2Fsld%2Fgeoserver-style-test-no-named-style1.sld&amp;layers=US-DE_DGS_100k_Surficial_Geology&amp;">SLD WMS GetMap request with LAYERS and STYLES parameter, use SLD with workspace prefix</a>. Note the different sld file-- this <a href="http://ogc.bgs.ac.uk/sld/geoserver-style-test-no-named-style1.sld">SLD location</a>, has namedLayer/name=DGS_Surficial_and_Contact_Geology:US-DE_DGS_100k_Surficial_Geology. The prefix is the workspace name from the Geoserver configuration.</p>
<h1>Conclusions</h1>
<p>When Using Geoserver, the SLD needs to include the workspace name as a prefix on the NamedLayer/Name; When using ArcGIS, the NamedLayer/Name is not expected to have a prefix.  The layer name from the getCapabilities response provides the correct string to use if the endpoint URL used for Geoserver is the base URL for the service, with no workspace name.</p>
<p>For the USGIN use case, i.e. using the SAME SLD against several geosciml-portrayal based WMS services, in may be necessary to provide a two named layers, one with and one without a workspace prefix, and Geoserver implementations may have to be required to use the same workspace name for gsmlp layers.</p>
